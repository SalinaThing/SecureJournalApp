<div class="bg-white dark:bg-neutral-800 rounded-2xl border border-neutral-200 dark:border-neutral-700 p-8 shadow-sm">
    <div class="flex justify-between items-start mb-6">
        <div>
            <div class="flex items-center gap-2 mb-2">
                <span class="material-icons text-green-600">mood</span>
                <h3 class="font-bold text-2xl text-neutral-900 dark:text-white">Mood</h3>
            </div>
            <p class="text-neutral-600 dark:text-neutral-400 text-sm mt-1">Pick 1 primary mood and up to 2 secondary moods.</p>
        </div>
        @if (!string.IsNullOrEmpty(PrimaryMood))
        {
            <div class="px-4 py-2 rounded-full text-sm font-semibold bg-green-100 dark:bg-green-900/20 text-green-700 dark:text-green-300 uppercase tracking-widest">
                @PrimaryMood
            </div>
        }
    </div>

    @* Symmetric 50/50 split using minmax(0, 1fr) to prevent content-based stretching *@
    <div class="grid" style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 24px; width: 100%;">
        @* Left: Primary Mood Selection *@
        <div class="flex flex-col space-y-4" style="width: 100%;">
            <div class="flex justify-between items-center">
                <label class="text-sm font-bold text-neutral-700 dark:text-neutral-300 uppercase tracking-wider">Primary Mood (Required)</label>
                @if (showPrimaryError)
                {
                    <span class="text-xs font-bold text-red-500 uppercase tracking-widest">Required</span>
                }
            </div>

            <div class="p-4 border border-neutral-200 dark:border-neutral-600 rounded-xl @(showPrimaryError ? "border-red-500/50" : "")" style="min-height: 400px; width: 100%;">
                @foreach (var group in MoodTagGroup.MoodGroups)
                {
                    <div class="mb-4">
                        <div class="text-xs font-semibold text-neutral-500 dark:text-neutral-400 uppercase tracking-wide opacity-60 mb-2">@group.Key</div>
                        <div class="flex flex-wrap gap-2 mt-2">
                            @foreach (var mood in group.Value)
                            {
                                <button type="button"
                                        class="px-3 py-2 rounded-lg text-sm font-medium transition @(PrimaryMood == mood ? "bg-green-600 text-white" : "bg-neutral-100 dark:bg-neutral-700 text-neutral-700 dark:text-neutral-300 hover:bg-green-50 dark:hover:bg-green-900/20")"
                                        @onclick="() => SetPrimary(mood)">
                                    @mood
                                </button>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>

        @* Right: Secondary Mood Selection *@
        <div class="flex flex-col space-y-4" style="width: 100%;">
            <div class="flex justify-between items-end">
                <label class="text-sm font-bold text-neutral-700 dark:text-neutral-300 uppercase tracking-wider">Secondary Moods</label>
                <div class="@(showLimitError ? "text-red-500" : "text-neutral-500 dark:text-neutral-400") text-xs font-bold transition-colors">
                    @SecondaryMoods.Count / 2 @(showLimitError ? "MAX REACHED" : "SELECTED")
                </div>
            </div>

            <div class="p-4 border border-neutral-200 dark:border-neutral-600 rounded-xl" style="min-height: 400px; width: 100%;">
                @foreach (var group in MoodTagGroup.MoodGroups)
                {
                    <div class="mb-4">
                        <div class="text-xs font-semibold text-neutral-500 dark:text-neutral-400 uppercase tracking-wide opacity-60 mb-2">@group.Key</div>
                        <div class="flex flex-wrap gap-2 mt-2">
                            @foreach (var mood in group.Value)
                            {
                                bool isChecked = SecondaryMoods.Contains(mood);
                                bool isPrimary = PrimaryMood == mood;

                                <button type="button"
                                        disabled="@isPrimary"
                                        class="px-3 py-2 rounded-lg text-sm font-medium transition @(isChecked ? "bg-green-600 text-white" : "bg-neutral-100 dark:bg-neutral-700 text-neutral-700 dark:text-neutral-300 hover:bg-green-50 dark:hover:bg-green-900/20") @(isPrimary ? "opacity-20 cursor-not-allowed" : "")"
                                        @onclick="() => ToggleSecondary(mood)">
                                    @if (isChecked)
                                    {
                                        <span class="material-icons text-xs" style="display: inline;">done</span>
                                    }
                                    <span>@mood</span>
                                </button>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public string PrimaryMood { get; set; } = "";
    [Parameter] public EventCallback<string> PrimaryMoodChanged { get; set; }

    [Parameter] public List<string> SecondaryMoods { get; set; } = new List<string>();
    [Parameter] public EventCallback<List<string>> SecondaryMoodsChanged { get; set; }

    private bool showLimitError = false;
    private bool showPrimaryError = false;

    private async Task SetPrimary(string mood)
    {
        showPrimaryError = false;
        PrimaryMood = mood;
        if (SecondaryMoods.Contains(mood))
        {
            SecondaryMoods.Remove(mood);
            await SecondaryMoodsChanged.InvokeAsync(SecondaryMoods);
        }
        await PrimaryMoodChanged.InvokeAsync(PrimaryMood);
    }

    private async Task ToggleSecondary(string mood)
    {
        if (SecondaryMoods.Contains(mood))
        {
            SecondaryMoods.Remove(mood);
            showLimitError = false;
        }
        else if (SecondaryMoods.Count < 2)
        {
            SecondaryMoods.Add(mood);
            showLimitError = false;
        }
        else
        {
            showLimitError = true;
            StateHasChanged();
            await Task.Delay(2000);
            showLimitError = false;
        }

        await SecondaryMoodsChanged.InvokeAsync(SecondaryMoods);
    }

    public bool Validate()
    {
        showPrimaryError = string.IsNullOrEmpty(PrimaryMood);
        StateHasChanged();
        return !showPrimaryError;
    }
}