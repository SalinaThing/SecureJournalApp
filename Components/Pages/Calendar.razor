@page "/calendar"
@implements IDisposable
@using SecureJournal.Data.Models
@inject JournalEntryService Entries
@inject CalendarService CalendarState

<div class="min-h-screen bg-gradient-to-br from-neutral-50 to-neutral-100 dark:from-neutral-900 dark:to-neutral-800 p-4 md:p-8">
    <div class="max-w-5xl mx-auto">
        
        @* Header *@
        <div class="bg-white dark:bg-neutral-800 rounded-2xl border border-neutral-200 dark:border-neutral-700 p-8 shadow-sm mb-8">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div>
                    <div class="flex items-center gap-3 mb-2">
                        <span class="material-icons text-green-600 text-3xl">calendar_today</span>
                        <h1 class="text-4xl font-bold text-neutral-900 dark:text-white">Calendar</h1>
                    </div>
                    <p class="text-neutral-600 dark:text-neutral-400">Click a date to view your entries</p>
                </div>

                <div class="flex gap-2">
                    <a class="px-4 py-2 bg-neutral-200 dark:bg-neutral-700 hover:bg-neutral-300 dark:hover:bg-neutral-600 text-neutral-900 dark:text-white font-semibold rounded-lg transition flex items-center gap-2" href="/timeline">
                        <span class="material-icons">history</span>Timeline
                    </a>
                    <a class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition flex items-center gap-2" href="/">
                        <span class="material-icons">add</span>New Entry
                    </a>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            @* Calendar View *@
            <div class="lg:col-span-2 bg-white dark:bg-neutral-800 rounded-2xl border border-neutral-200 dark:border-neutral-700 p-8 shadow-sm">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-neutral-900 dark:text-white mb-2">Month View</h2>
                    <p class="text-sm text-neutral-600 dark:text-neutral-400">Days with entries are highlighted in green</p>
                </div>

                <div class="bg-neutral-50 dark:bg-neutral-700/50 rounded-lg p-6">
                    <CalendarMonth DatesWithEntries="@monthKeys" OnDateClick="DateClicked" Compact="false" />
                </div>
            </div>

            @* Entry Details *@
            <div class="bg-white dark:bg-neutral-800 rounded-2xl border border-neutral-200 dark:border-neutral-700 p-8 shadow-sm">
                <h2 class="text-2xl font-bold text-neutral-900 dark:text-white mb-2">Selected Date</h2>
                <div class="px-4 py-2 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-lg font-semibold text-center mb-6">@CalendarState.SelectedDate.ToString("MMM dd, yyyy")</div>

                <div class="space-y-4">
                    @if (selectedEntry == null)
                    {
                        <div class="text-center py-8">
                            <span class="material-icons text-4xl text-neutral-400 mb-2 block">article</span>
                            <p class="text-neutral-600 dark:text-neutral-400">No entry for this date</p>
                        </div>

                        <div class="space-y-2">
                            <a class="block px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition text-center" href="/">
                                <span class="material-icons inline mr-2 align-text-bottom">add</span>Create Entry
                            </a>
                            <a class="block px-4 py-3 bg-neutral-200 dark:bg-neutral-700 hover:bg-neutral-300 dark:hover:bg-neutral-600 text-neutral-900 dark:text-white font-semibold rounded-lg transition text-center" href="/search">
                                <span class="material-icons inline mr-2 align-text-bottom">search</span>Search
                            </a>
                        </div>
                    }
                    else
                    {
                        <div class="bg-neutral-50 dark:bg-neutral-700/50 rounded-lg p-4">
                            <h3 class="font-bold text-lg text-neutral-900 dark:text-white mb-2">@selectedEntry.Title</h3>
                            <div class="flex items-center gap-2 mb-3">
                                <span class="px-2 py-1 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 rounded text-xs font-semibold">@selectedEntry.Category</span>
                            </div>

                            @if (!string.IsNullOrWhiteSpace(selectedEntry.PrimaryMood))
                            {
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="material-icons text-sm text-purple-500">sentiment_satisfied</span>
                                    <span class="text-sm text-neutral-700 dark:text-neutral-300"><strong>Mood:</strong> @selectedEntry.PrimaryMood</span>
                                </div>
                            }

                            @if (!string.IsNullOrWhiteSpace(selectedEntry.TagsCsv))
                            {
                                <div class="flex items-center gap-2 flex-wrap mt-3">
                                    <span class="material-icons text-sm text-pink-500">label</span>
                                    @foreach (var tag in selectedEntry.TagsCsv.Split(','))
                                    {
                                        <span class="px-2 py-1 bg-pink-100 dark:bg-pink-900/30 text-pink-700 dark:text-pink-300 rounded text-xs font-semibold">@tag.Trim()</span>
                                    }
                                </div>
                            }
                        </div>

                        <div class="space-y-2">
                            <a class="block px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition text-center" href="@($"/entry/{selectedEntry.Id}")">Open Entry</a>
                            <a class="block px-4 py-3 bg-neutral-200 dark:bg-neutral-700 hover:bg-neutral-300 dark:hover:bg-neutral-600 text-neutral-900 dark:text-white font-semibold rounded-lg transition text-center" href="/timeline">View Timeline</a>
                        </div>
                    }
                </div>

                <div class="mt-6 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-lg text-xs text-blue-700 dark:text-blue-300">
                    <strong>Tip:</strong> Use Search to filter by mood, tags, and date range.
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private HashSet<string> monthKeys = new(StringComparer.OrdinalIgnoreCase);
    private SecureJournal.Data.Models.JournalEntry? selectedEntry;

    protected override async Task OnInitializedAsync()
    {
        CalendarState.SelectedDateChanged += OnDateChanged;
        Entries.DataChanged += OnDataChanged;

        await LoadMonthKeysAsync(DateTime.Now);
        await LoadSelectedAsync();
    }

    private async void OnDateChanged()
    {
        await LoadSelectedAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async void OnDataChanged()
    {
        await LoadMonthKeysAsync(CalendarState.SelectedDate);
        await LoadSelectedAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task DateClicked(DateTime d)
    {
        CalendarState.SetSelectedDate(d);
        await LoadMonthKeysAsync(d);
    }

    private async Task LoadMonthKeysAsync(DateTime month)
    {
        monthKeys = await Entries.GetDateKeysWithEntriesAsync(month);
    }

    private async Task LoadSelectedAsync()
    {
        selectedEntry = await Entries.GetByDateAsync(CalendarState.SelectedDate);
    }

    public void Dispose()
    {
        CalendarState.SelectedDateChanged -= OnDateChanged;
        Entries.DataChanged -= OnDataChanged;
    }
}
