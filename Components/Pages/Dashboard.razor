@page "/"
@page "/dashboard"
@using SecureJournal.Data.Services
@inject AuthService Auth
@inject NavigationManager Nav
@inject JournalEntryService Entries
@implements IDisposable

<div class="min-h-screen bg-gradient-to-br from-neutral-50 to-neutral-100 dark:from-neutral-900 dark:to-neutral-800 p-4 md:p-8">
    <div class="max-w-[1400px] mx-auto space-y-8">
        
        @* Welcome Header with Gradient *@
        <div class="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-2xl border border-green-200 dark:border-green-700 p-8 shadow-sm">
            <h1 class="text-5xl font-bold text-neutral-900 dark:text-white mb-2">
                Welcome back, <span class="text-green-600">@Auth.CurrentUser</span>! ðŸ‘‹
            </h1>
            <p class="text-neutral-600 dark:text-neutral-400 text-lg">Your journaling dashboard at a glance</p>
        </div>

        @* Enhanced Stats Section *@
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            @* Entries this Week *@
            <div class="bg-white dark:bg-neutral-800 rounded-2xl border border-neutral-200 dark:border-neutral-700 p-8 shadow-sm hover:shadow-md transition-shadow group">
                <div class="flex items-start justify-between mb-6">
                    <div class="flex-1">
                        <p class="text-neutral-600 dark:text-neutral-400 text-sm font-semibold uppercase tracking-wide mb-2">Entries This Week</p>
                        <p class="text-5xl font-bold text-green-600 mb-2">@entriesThisWeek</p>
                        <div class="h-1 w-16 bg-gradient-to-r from-green-500 to-emerald-500 rounded-full"></div>
                    </div>
                    <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-green-100 to-emerald-100 dark:from-green-900/30 dark:to-emerald-900/30 flex items-center justify-center group-hover:scale-110 transition-transform">
                        <span class="material-icons text-4xl text-green-600">edit_calendar</span>
                    </div>
                </div>
                <p class="text-xs text-neutral-500 dark:text-neutral-400">Keep up the great work! ðŸŽ¯</p>
            </div>

            @* Current Streak *@
            <div class="bg-white dark:bg-neutral-800 rounded-2xl border border-neutral-200 dark:border-neutral-700 p-8 shadow-sm hover:shadow-md transition-shadow group">
                <div class="flex items-start justify-between mb-6">
                    <div class="flex-1">
                        <p class="text-neutral-600 dark:text-neutral-400 text-sm font-semibold uppercase tracking-wide mb-2">Current Streak</p>
                        <p class="text-5xl font-bold text-green-600 mb-2">@currentStreak</p>
                        <div class="h-1 w-16 bg-gradient-to-r from-green-500 to-emerald-500 rounded-full"></div>
                    </div>
                    <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-green-100 to-emerald-100 dark:from-green-900/30 dark:to-emerald-900/30 flex items-center justify-center group-hover:scale-110 transition-transform">
                        <span class="material-icons text-4xl text-green-600">local_fire_department</span>
                    </div>
                </div>
                <p class="text-xs text-neutral-500 dark:text-neutral-400">Days in a row ðŸ”¥</p>
            </div>

            @* Recent Mood *@
            <div class="bg-white dark:bg-neutral-800 rounded-2xl border border-neutral-200 dark:border-neutral-700 p-8 shadow-sm hover:shadow-md transition-shadow group">
                <div class="flex items-start justify-between mb-6">
                    <div class="flex-1">
                        <p class="text-neutral-600 dark:text-neutral-400 text-sm font-semibold uppercase tracking-wide mb-2">Recent Mood</p>
                        <p class="text-5xl font-bold text-green-600 mb-2">@commonMood</p>
                        <div class="h-1 w-16 bg-gradient-to-r from-green-500 to-emerald-500 rounded-full"></div>
                    </div>
                    <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-green-100 to-emerald-100 dark:from-green-900/30 dark:to-emerald-900/30 flex items-center justify-center group-hover:scale-110 transition-transform">
                        <span class="material-icons text-4xl text-green-600">sentiment_satisfied</span>
                    </div>
                </div>
                <p class="text-xs text-neutral-500 dark:text-neutral-400">From your last entry ðŸ˜Š</p>
            </div>
        </div>

        @* Quick Access Section with Better Design *@
        <div>
            <div class="mb-6 flex items-center gap-3">
                <span class="material-icons text-green-600 text-2xl">lightning_bolt</span>
                <h2 class="text-3xl font-bold text-neutral-900 dark:text-white">Quick Access</h2>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                
                @* Calendar Card - Enhanced *@
                <a href="/calendar" class="group relative overflow-hidden bg-white dark:bg-neutral-800 rounded-2xl border border-neutral-200 dark:border-neutral-700 p-6 shadow-sm hover:shadow-lg hover:border-green-400 dark:hover:border-green-600 transition-all">
                    <div class="absolute -right-8 -top-8 w-32 h-32 bg-green-50 dark:bg-green-900/10 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <div class="relative z-10">
                        <div class="flex items-start gap-4 mb-4">
                            <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-green-100 to-emerald-100 dark:from-green-900/30 dark:to-emerald-900/30 flex items-center justify-center group-hover:scale-110 transition-transform">
                                <span class="material-icons text-2xl text-green-600">calendar_today</span>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-neutral-900 dark:text-white">Calendar</h3>
                                <p class="text-xs text-neutral-500 dark:text-neutral-400">View by date</p>
                            </div>
                        </div>
                        <p class="text-sm text-neutral-600 dark:text-neutral-400 mb-4 leading-relaxed">Browse your entries organized by calendar dates and track your patterns.</p>
                        <div class="flex items-center text-green-600 font-semibold text-sm group-hover:gap-3 transition-all gap-2">
                            Open <span class="material-icons text-sm">arrow_forward</span>
                        </div>
                    </div>
                </a>

                @* Timeline Card - Enhanced *@
                <a href="/timeline" class="group relative overflow-hidden bg-white dark:bg-neutral-800 rounded-2xl border border-neutral-200 dark:border-neutral-700 p-6 shadow-sm hover:shadow-lg hover:border-green-400 dark:hover:border-green-600 transition-all">
                    <div class="absolute -right-8 -top-8 w-32 h-32 bg-green-50 dark:bg-green-900/10 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <div class="relative z-10">
                        <div class="flex items-start gap-4 mb-4">
                            <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-green-100 to-emerald-100 dark:from-green-900/30 dark:to-emerald-900/30 flex items-center justify-center group-hover:scale-110 transition-transform">
                                <span class="material-icons text-2xl text-green-600">history</span>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-neutral-900 dark:text-white">Timeline</h3>
                                <p class="text-xs text-neutral-500 dark:text-neutral-400">Chronological view</p>
                            </div>
                        </div>
                        <p class="text-sm text-neutral-600 dark:text-neutral-400 mb-4 leading-relaxed">See your entries in chronological order and relive your personal journey.</p>
                        <div class="flex items-center text-green-600 font-semibold text-sm group-hover:gap-3 transition-all gap-2">
                            Open <span class="material-icons text-sm">arrow_forward</span>
                        </div>
                    </div>
                </a>

                @* Analytics Card - Enhanced *@
                <a href="/analytics" class="group relative overflow-hidden bg-white dark:bg-neutral-800 rounded-2xl border border-neutral-200 dark:border-neutral-700 p-6 shadow-sm hover:shadow-lg hover:border-green-400 dark:hover:border-green-600 transition-all">
                    <div class="absolute -right-8 -top-8 w-32 h-32 bg-green-50 dark:bg-green-900/10 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <div class="relative z-10">
                        <div class="flex items-start gap-4 mb-4">
                            <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-green-100 to-emerald-100 dark:from-green-900/30 dark:to-emerald-900/30 flex items-center justify-center group-hover:scale-110 transition-transform">
                                <span class="material-icons text-2xl text-green-600">insights</span>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-neutral-900 dark:text-white">Analytics</h3>
                                <p class="text-xs text-neutral-500 dark:text-neutral-400">Insights & trends</p>
                            </div>
                        </div>
                        <p class="text-sm text-neutral-600 dark:text-neutral-400 mb-4 leading-relaxed">Discover patterns in your emotions, moods, and behaviors through data.</p>
                        <div class="flex items-center text-green-600 font-semibold text-sm group-hover:gap-3 transition-all gap-2">
                            Open <span class="material-icons text-sm">arrow_forward</span>
                        </div>
                    </div>
                </a>
            </div>
        </div>

        @* Today's Entry Section *@
        <div class="bg-white dark:bg-neutral-800 rounded-2xl border border-neutral-200 dark:border-neutral-700 p-8 shadow-sm">
            <div class="flex items-center gap-3 mb-6">
                <span class="material-icons text-green-600 text-2xl">edit_note</span>
                <h2 class="text-3xl font-bold text-neutral-900 dark:text-white">Today's Entry</h2>
            </div>
            <TodayEntryCard />
        </div>
    </div>
</div>

@code {
    private string entriesThisWeek = "0";
    private string currentStreak = "0";
    private string commonMood = "-";

    protected override async Task OnInitializedAsync()
    {
        Entries.DataChanged += Refresh;
        await LoadStatsAsync();
    }

    private async void Refresh()
    {
        await LoadStatsAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadStatsAsync()
    {
        // Fetch streak stats from service
        var (streak, _, _) = await Entries.GetStreakStatsAsync();
        currentStreak = streak.ToString();

        var allEntries = await Entries.GetAllAsync();
        var weekAgo = DateTime.Now.Date.AddDays(-7);

        // FIX: Changed .Date to .EntryDate to match JournalEntry model
        entriesThisWeek = allEntries.Count(x => x.EntryDate >= weekAgo).ToString();

        // FIX: Changed .Date to .EntryDate to match JournalEntry model
        var latestEntry = allEntries.OrderByDescending(x => x.EntryDate).FirstOrDefault();
        commonMood = latestEntry?.PrimaryMood ?? "None";
    }

    public void Dispose()
    {
        Entries.DataChanged -= Refresh;
    }
}