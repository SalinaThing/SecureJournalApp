@*page UI for Search & Filter and exporting results *@

@page "/search"
@using SecureJournal.Data.Models
@inject JournalEntryService Entries
@inject ExportService Pdf
@using Microsoft.AspNetCore.Components.Forms

<div class="min-h-screen bg-gradient-to-br from-neutral-50 to-neutral-100 dark:from-neutral-900 dark:to-neutral-800 p-4 md:p-8">
    <div class="max-w-5xl mx-auto">
        
        @* Header *@
        <div class="bg-white dark:bg-neutral-800 rounded-2xl border border-neutral-200 dark:border-neutral-700 p-8 shadow-sm mb-8">
            <div class="flex items-center gap-3 mb-2">
                <span class="material-icons text-green-600 text-3xl">search</span>
                <h1 class="text-4xl font-bold text-neutral-900 dark:text-white">Search & Filter</h1>
            </div>
            <p class="text-neutral-600 dark:text-neutral-400">Find entries and export by filters</p>
        </div>

        @* Filter Card *@
        <div class="bg-white dark:bg-neutral-800 rounded-2xl border border-neutral-200 dark:border-neutral-700 p-8 shadow-sm mb-8">
            <h2 class="text-xl font-bold text-neutral-900 dark:text-white mb-6">Filters</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    @* Creating a text input for searching by title/content *@
                    <label class="block text-sm font-semibold text-neutral-700 dark:text-neutral-300 mb-2">Search Text</label>
                    <input class="w-full px-4 py-3 border border-neutral-200 dark:border-neutral-600 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent dark:bg-neutral-700 dark:text-white" 
                           @bind="text" 
                           placeholder="Search title or content..." />
                </div>

                <div>
                    @* Creating a dropdown for filtering by primary mood *@
                    <label class="block text-sm font-semibold text-neutral-700 dark:text-neutral-300 mb-2">Primary Mood</label>
                    <select class="w-full px-4 py-3 border border-neutral-200 dark:border-neutral-600 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent dark:bg-neutral-700 dark:text-white"
                            @bind="mood">
                        <option value="">Any mood</option>
                        @foreach (var m in allPrimaryMoods)
                        {
                            <option value="@m">@m</option>
                        }
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    @* Creating a date picker for the start date of the range *@
                    <label class="block text-sm font-semibold text-neutral-700 dark:text-neutral-300 mb-2">From Date</label>
                    <InputDate class="w-full px-4 py-3 border border-neutral-200 dark:border-neutral-600 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent dark:bg-neutral-700 dark:text-white" 
                               TValue="DateOnly?" 
                               @bind-Value="fromDate" />
                </div>
                <div>
                    @* Creating a date picker for the end date of the range *@
                    <label class="block text-sm font-semibold text-neutral-700 dark:text-neutral-300 mb-2">To Date</label>
                    <InputDate class="w-full px-4 py-3 border border-neutral-200 dark:border-neutral-600 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent dark:bg-neutral-700 dark:text-white" 
                               TValue="DateOnly?" 
                               @bind-Value="toDate" />
                </div>
            </div>

            <div class="mb-6">
                @* Creating a dropdown for filtering by tag *@
                <label class="block text-sm font-semibold text-neutral-700 dark:text-neutral-300 mb-2">Tag</label>
                <select class="w-full px-4 py-3 border border-neutral-200 dark:border-neutral-600 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent dark:bg-neutral-700 dark:text-white"
                        @bind="tag">
                    <option value="">Any tag</option>
                    @foreach (var t in allTags)
                    {
                        <option value="@t">@t</option>
                    }
                </select>
            </div>

            <div class="flex gap-3">
                @* Creating buttons to run search and clear filters *@
                <button class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition" 
                        @onclick="RunSearch">
                    <span class="material-icons inline mr-2 align-text-bottom">search</span>Search
                </button>
                <button class="px-6 py-3 bg-neutral-200 dark:bg-neutral-700 hover:bg-neutral-300 dark:hover:bg-neutral-600 text-neutral-900 dark:text-white font-semibold rounded-lg transition" 
                        @onclick="Clear">
                    <span class="material-icons inline mr-2 align-text-bottom">clear</span>Clear
                </button>
            </div>
        </div>

        @* Results Card *@
        <div class="bg-white dark:bg-neutral-800 rounded-2xl border border-neutral-200 dark:border-neutral-700 p-8 shadow-sm">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-2">
                    <span class="material-icons text-green-600">list</span>
                    <h2 class="text-2xl font-bold text-neutral-900 dark:text-white">Results</h2>
                    <span class="bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 px-3 py-1 rounded-full font-semibold text-sm">@results.Count</span>
                </div>
                @* Creating a button to export the current date range results *@
                <button class="px-4 py-2 bg-green-100 dark:bg-green-900/30 hover:bg-green-200 dark:hover:bg-green-900/50 text-green-700 dark:text-green-300 font-semibold rounded-lg transition" 
                        @onclick="ExportRange">
                    <span class="material-icons inline mr-1 align-text-bottom text-lg">download</span>Export PDF
                </button>
            </div>

            @if (!string.IsNullOrWhiteSpace(message))
            {
                @* Showing status messages to the user (validation/export path) *@
                <div class="mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-lg text-blue-700 dark:text-blue-300 text-sm">
                    @message
                </div>
            }

            @if (results.Count == 0)
            {
                <div class="text-center py-12">
                    <span class="material-icons text-4xl text-neutral-400 mb-4 block">search_off</span>
                    <p class="text-neutral-600 dark:text-neutral-400 text-lg">No results found</p>
                    <p class="text-neutral-500 dark:text-neutral-500 text-sm mt-2">Try adjusting your filters</p>
                </div>
            }
            else
            {
                <div class="space-y-4">
                    @* Rendering each result as a card with basic details *@
                    @foreach (var e in results)
                    {
                        <div class="p-4 border border-neutral-200 dark:border-neutral-700 rounded-lg hover:border-green-300 dark:hover:border-green-600 transition">
                            <div class="flex items-start justify-between mb-3">
                                <div>
                                    <h3 class="font-bold text-neutral-900 dark:text-white text-lg">@e.Title</h3>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="material-icons text-gray-400 text-sm">calendar_today</span>
                                        <span class="text-sm text-neutral-600 dark:text-neutral-400">@e.EntryDate.ToString("MMM dd, yyyy")</span>
                                        <span class="text-sm text-neutral-600 dark:text-neutral-400">•</span>
                                        <span class="px-2 py-1 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 rounded text-xs font-semibold">@e.Category</span>
                                    </div>
                                </div>
                                @* Creating a link to open the entry *@
                                <a class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition text-sm" 
                                   href="@($"/entry/{e.Id}")">
                                    <span class="material-icons inline align-text-bottom">open_in_new</span>Open
                                </a>
                            </div>

                            @if (!string.IsNullOrWhiteSpace(e.PrimaryMood))
                            {
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="material-icons text-sm text-purple-500">sentiment_satisfied</span>
                                    <span class="text-sm text-neutral-600 dark:text-neutral-400"><strong>Mood:</strong> @e.PrimaryMood</span>
                                </div>
                            }
                            @if (!string.IsNullOrWhiteSpace(e.TagsCsv))
                            {
                                <div class="flex items-center gap-2 flex-wrap">
                                    <span class="material-icons text-sm text-pink-500">label</span>
                                    @foreach (var t in e.TagsCsv.Split(','))
                                    {
                                        <span class="px-2 py-1 bg-pink-100 dark:bg-pink-900/30 text-pink-700 dark:text-pink-300 rounded text-xs font-semibold">@t.Trim()</span>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

@code {
    // Creating a query parameter so /search?q=something can pre-fill the search box
    [SupplyParameterFromQuery(Name = "q")]
    public string? QueryText { get; set; }

    // Creating local state for the filters
    private string text = "";
    private string mood = "";
    private string tag = "";

    // Creating date range state (DateOnly? avoids binder issues)
    private DateOnly? fromDate;
    private DateOnly? toDate;

    // Creating simple UI state for messages and results
    private string message = "";
    private List<SecureJournal.Data.Models.JournalEntry> results = new();

    // Creating lists for dropdown options
    private List<string> allPrimaryMoods = new();
    private List<string> allTags = new();

    protected override async Task OnInitializedAsync()
    {
        // Setting the search text from the query string if it exists
        text = QueryText ?? "";

        // Loading mood options from the database/service
        var moods = await Entries.GetMoodCountsAsync();
        allPrimaryMoods = moods.Keys.ToList();

        // Loading tag options from the database/service
        var tags = await Entries.GetTagCountsAsync();
        allTags = tags.Keys.ToList();

        // Running an initial search so the page shows results on load
        await RunSearch();
    }

    // Creating a helper function to convert DateOnly? to a DateTime? at the start of the day
    private static DateTime? ToDateTimeStart(DateOnly? d)
        => d.HasValue ? d.Value.ToDateTime(TimeOnly.MinValue) : null;

    // Creating a helper function to convert DateOnly? to a DateTime? at the end of the day
    private static DateTime? ToDateTimeEnd(DateOnly? d)
        => d.HasValue ? d.Value.ToDateTime(TimeOnly.MaxValue) : null;

    private async Task RunSearch()
    {
        // Clearing any previous message
        message = "";

        // Converting the date filters into DateTime range values
        var from = ToDateTimeStart(fromDate);
        var to = ToDateTimeEnd(toDate);

        // Calling the service to search entries using the selected filters
        results = await Entries.SearchAsync(text, from, to, mood, tag);
    }

    private async Task ExportRange()
    {
        // Converting the selected dates into DateTime values for exporting
        var from = ToDateTimeStart(fromDate);
        var to = ToDateTimeEnd(toDate);

        // Validating that both dates are selected before exporting
        if (!from.HasValue || !to.HasValue)
        {
            message = "Please set From and To dates first.";
            return;
        }

        // Exporting the filtered results to a PDF file
        var path = await Pdf.ExportRangeAsync(from.Value, to.Value);
        message = $"PDF saved to: {path}";
    }

    private async Task Clear()
    {
        // Resetting all filters back to default values
        text = "";
        mood = "";
        tag = "";
        fromDate = null;
        toDate = null;

        // Running search again to refresh the results after clearing
        await RunSearch();
    }
}
